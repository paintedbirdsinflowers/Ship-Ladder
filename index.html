<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>THE SHIP LADDER ♡</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#fff5fb; font-family:'Segoe UI',sans-serif; color:#333; }
    .container { max-width:800px; margin:4rem auto; }
    h1 { text-align:center; color:#ff6bc2; font-size:3.5rem; text-shadow:2px 2px #ffe0f0; }
    .top10 { background:white; border-radius:25px; padding:25px; box-shadow:0 10px 30px rgba(255,107,194,0.15); margin-bottom:3rem; }
    .rank { font-size:3rem; font-weight:bold; color:#ff6bc2; }
    .ship-name { font-size:1.6rem; font-weight:bold; }
    .count { color:#ff6bc2; }
    .ladder-item { background:white; padding:16px; margin:8px 0; border-radius:15px; box-shadow:0 4px 15px rgba(255,107,194,0.1); }
    button { background:#ff6bc2; border:none; border-radius:50px; padding:12px 40px; font-size:1.2rem; }
    button:hover { background:#ff4a9e; }
    .heart { color:#ff6bc2; animation:pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% {transform:scale(1)} 50% {transform:scale(1.3)} }
  </style>
</head>
<body>
  <div class="container">
    <h1>♡ THE SHIP LADDER ♡</h1>
    <p class="text-center lead mb-5">spam your otp and make it climb • top 10 resets every monday</p>

    <form id="shipForm" class="text-center mb-5">
      <input type="text" id="shipName" placeholder="stucky • klance • drarry • etc" required 
             class="form-control d-inline-block w-50" style="border-radius:50px;padding:15px;">
      <button type="submit" class="btn text-white mt-3">SHIP IT <span class="heart">♡</span></button>
    </form>

    <div class="top10">
      <h2 class="text-center mb-4">TOP 10 SHIPS THIS WEEK</h2>
      <div id="top10" class="text-center"></div>
    </div>

    <h3 class="text-center mb-4">full ladder – newest first</h3>
    <div id="ladder"></div>
  </div>

  <script>
    
    const BIN_ID = '6924316843b1c97be9c1b805';
    
    
    const SECRET_KEY = '$2a$10$CiJablwyEBJW9O7UqujyE.egcrgbvoZWG4pNMTjY2.gGWnIiKWlSW';
    

    const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    async function loadShips() {
      const res = await fetch(URL + '/latest', { headers: { 'X-Master-Key': SECRET_KEY } });
      const data = await res.json();
      return data.record.ships || [];
    }

    function timeAgo(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      let interval = seconds / 86400;
      if (interval > 7) return Math.floor(interval) + "d ago";
      if (interval > 1) return Math.floor(interval) + "d ago";
      interval = seconds / 3600;
      if (interval > 1) return Math.floor(interval) + "h ago";
      interval = seconds / 60;
      if (interval > 1) return Math.floor(interval) + "m ago";
      return "just now";
    }

    async function showAll() {
      let ships = await loadShips();
      ships = ships.sort((a,b) => new Date(b.time) - new Date(a.time));

      document.getElementById('ladder').innerHTML = ships.map(s => `
        <div class="ladder-item">
          <strong style="color:#ff6bc2;font-size:1.4rem;">${s.name}</strong>
          <small class="float-end text-muted">${timeAgo(s.time)}</small>
        </div>
      `).join('');

      const oneWeekAgo = new Date(Date.now() - 7*24*60*60*1000);
      const thisWeek = ships.filter(s => new Date(s.time) > oneWeekAgo);
      const counts = {};
      thisWeek.forEach(s => counts[s.name] = (counts[s.name] || 0) + 1);
      const top = Object.entries(counts)
        .sort((a,b) => b[1] - a[1])
        .slice(0,10);

      document.getElementById('top10').innerHTML = top.length ? top.map(([name,count],i) => `
        <div class="d-flex justify-content-between align-items-center mb-3 px-4">
          <span class="rank">#${i+1}</span>
          <span class="ship-name">${name}</span>
          <span class="count">${count} ${count===1?'vote':'votes'} ♡</span>
        </div>
      `).join('') : '<p class="text-muted">no ships this week yet — be the first! ♡</p>';
    }

    document.getElementById('shipForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('shipName').value.trim().toUpperCase();
      if (!name) return;

      const ships = await loadShips();
      ships.push({ name, time: new Date().toISOString() });

      await fetch(URL, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-Master-Key': SECRET_KEY },
        body: JSON.stringify({ ships })
      });

      document.getElementById('shipName').value = '';
      showAll();
    });

    showAll();
    setInterval(showAll, 30000);
  </script>
</body>
  </html>
